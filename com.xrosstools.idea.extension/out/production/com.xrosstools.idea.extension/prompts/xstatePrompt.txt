# xstate生成规范
xstate是状态机模型，一个模型可以包含多个状态机模型

## XML格式规范
- 开头固定：`<?xml version="1.0" encoding="UTF-8"?>`：必须完整输出
- `<state_machine_diagram>`：根节点（父节点，内部包含'<name>'节点，`<description>`节点，`<state_machines>`节点)
  - `<name>名字<name/>`：模型文件名字（字符串，选填）
  - `<description>模型文件描述<description/>`：模型文件描述（字符串，选填），概括用户需求的核心思想
  - `<state_machines>`：状态机根节点（父节点，内部包含多个`<state_machine>`节点）
    -`<state_machine>`：状态机节点（父节点，包含'<name>'节点，`<description>`节点，`<states>`,`<events>`，`<transitions>`节点）
      - `<name>状态机名字<description/>`：状态机名字（字符串，必填），在所有状态机中唯一
      - `<description>状态机描述<description/>`：状态机描述（字符串，选填）
      - `<states>`：状态节点列表（父节点，内部可包含状态节点：`<start>`，`<end>`，`<state>`）
        - `<start id="start" x_loc="x坐标" y_loc="y坐标">`：开始节点（start节点的`id`属性缺省为`start`），标志状态机开始
        - `<end id="end" x_loc="x坐标" y_loc="y坐标"/>`：结束节点（`id`属性缺省为`end`），标志状态机结束
        - `<state id="状态标识符，例如`normal_state`（必填）" Label="状态标签，例如`normal_state`（选填）" x_loc="x坐标" y_loc="y坐标">`：状态节点
          - id属性的格式都要符合Java标识符规范并且在同级节点中保持唯一
          - `<description>状态节点描述（选填）</description>`
          - `<reference>子状态机name（选填）</reference>`
          - `<entry_action>进入当前状态触发器（Java类全名，选填）</entry_action>`
          - `<exit_action>离开当前状态触发器（Java类全名，选填）</exit_action>`
    - `<events>`：事件列表（父节点，包含`<event>`节点）
      - `<event id="事件标志符（必填，例如`email_recieved`）" Label="事件标签（选填，例如`收到邮件`）">事件描述（选填）</event>`
        - id属性的格式都要符合Java标识符规范并且在同级节点中保持唯一
      - `<transitions>`：状态节点连接列表（父节点，包含`<transition>`节点）
        - `<transition event_id="连接标识符（必填）" source_id="源节点id（必填）" style="连线风格标识符" target_id="目标节点id（必填）" transit_action="状态转移触发器（Java类全名，选填）" transit_guard="状态转移条件判断（Java类全名，选填）"/>`：
          - style属性的可选范围是：`direct`,`heightFirst`, `widthFirst`
            - `direct`：直线连接
            - `heightFirst`：从源节点先水平延申到目标节点边缘，再垂直延申到目标节点
            - `widthFirst`：从源节点先垂直延申到目标节点边缘，再水平延申到目标节点

## XML格式限制
- 可见性
  - state和event的可见性仅限于所属的state_machine
- 节点布局规则
  - 不同状态机中的坐标属性都各自独立，既都从原点开始，不考虑其他状态机中的节点元素位置
  - 每个状态机只包含1个开始和1个结束节点
  - 首尾相连的顺序多个节点应该沿水平中线对齐
  - 节点大小规格
    - 开始，结束节点的高度和宽度都是16像素
    - 状态节点的高度是50，宽度是（显示的字数*10）+ 10
      - 如果有label，则字数按照label的字数，没有则按照id的字数
  - 整体布局应沿主要状态变迁线路水平布局，间隔至少100像素
  - 同一状态节点的后继非主线节点应该垂直分布，间隔至少100像素
  - 为避免节点显示在范围之外，每个节点的x，y坐标都不能小于100
- `style`设置规则
  - 缺省使用`direct`
  - 如果从源节点到目标节点有多条连线，每条应该设置不同的style

## 示例
### 示例1：用户需求
创建一个表示数据库从开机到关机间状态变化的状态机，包括四个状态：开始，正常，无法服务和结束。开始状态通过初始化事件到达正常状态，正常状态通过关机事件到达结束状态，正常状态通过markdown事件到达无法服务状态，无法服务状态通过markup事件到达正常状态，无法服务状态通过关机事件到达结束状态

### 思考过程：
* 提取信息：模型名，状态机名，状态节点，事件，连接等信息。
* 布局：水平主线。开始 -> 各中间节点 -> 结束。
* 计算坐标，应用连接线样式规则。

### 示例1：输出XML
```xml
<?xml version="1.0" encoding="UTF-8"?>

<state_machine_diagram>
 <name>StateMachineDiagram</name>
 <description/>
 <state_machines>
  <state_machine>
   <name>DB Health Lifecycle</name>
   <description/>
   <states>
    <state id="Normal" label="" x_loc="209" y_loc="156">
     <description/>
     <reference/>
     <entry_action>com.xrosstools.xstate.sample.TestEnterAction</entry_action>
     <exit_action>com.xrosstools.xstate.sample.TestAction</exit_action>
    </state>
    <state id="OutOfService" label="" x_loc="401" y_loc="375">
     <description/>
     <reference/>
     <entry_action>com.xrosstools.xstate.sample.TestEnterAction</entry_action>
     <exit_action>com.xrosstools.xstate.sample.TestAction</exit_action>
    </state>
    <start id="start" label="" x_loc="57" y_loc="173">
     <description/>
     <reference/>
     <entry_action/>
     <exit_action/>
    </start>
    <end id="end" label="" x_loc="633" y_loc="173">
     <description/>
     <reference/>
     <entry_action/>
     <exit_action/>
    </end>
   </states>
   <events>
    <event id="initialize" label="">ddddd</event>
    <event id="shutdown" label=""/>
    <event id="markdown" label=""/>
    <event id="markup" label=""/>
   </events>
   <transitions>
    <transition event_id="shutdown" source_id="Normal" style="direct" target_id="end" transit_action="" transit_guard=""/>
    <transition event_id="markdown" source_id="Normal" style="heightFirst" target_id="OutOfService" transit_action="" transit_guard=""/>
    <transition event_id="shutdown" source_id="OutOfService" style="widthFirst" target_id="end" transit_action="" transit_guard=""/>
    <transition event_id="markup" source_id="OutOfService" style="direct" target_id="Normal" transit_action="" transit_guard=""/>
    <transition event_id="initialize" source_id="start" style="direct" target_id="Normal" transit_action="" transit_guard=""/>
   </transitions>
  </state_machine>
 </state_machines>
</state_machine_diagram>
```

